<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Support Over Silence for KIDS Certified Trainers Network</title>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', 'Segoe UI', Arial, sans-serif; background: #f5f0e6; color: #222b54; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  #header {
    background: white;
    color: #222b54;
    padding: 0 22px;
    height: 52px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }
  #header h1 { font-size: 1.05rem; font-weight: 700; letter-spacing: 0.3px; color: #222b54; }

  #controls {
    background: white;
    padding: 9px 20px;
    display: flex;
    gap: 14px;
    align-items: center;
    flex-shrink: 0;
    flex-wrap: wrap;
    border-bottom: 2px solid #e0dbce;
  }
  .filter-group { display: flex; gap: 5px; align-items: center; }
  .filter-label { color: #888; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; margin-right: 3px; }
  .filter-btn {
    background: transparent;
    border: 1.5px solid #ccc;
    color: #555;
    border-radius: 14px;
    padding: 4px 13px;
    font-size: 0.71rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn:hover { border-color: #fdb813; color: #222b54; }
  .filter-btn.active { background: #fdb813; border-color: #fdb813; color: #222b54; font-weight: 700; }
  .filter-select {
    background: transparent;
    border: 1.5px solid #ccc;
    color: #555;
    border-radius: 14px;
    padding: 4px 13px;
    font-size: 0.71rem;
    cursor: pointer;
    font-family: 'Lato', sans-serif;
    transition: all 0.15s;
  }
  .filter-select:focus { outline: none; border-color: #fdb813; }
  .filter-select:hover { border-color: #fdb813; color: #222b54; }

  #search-wrap {
    margin-left: auto;
    position: relative;
    display: flex;
    align-items: center;
  }
  #search-box {
    background: #f5f5f5;
    border: 1.5px solid #ccc;
    border-radius: 14px;
    padding: 4px 30px 4px 14px;
    color: #222b54;
    font-size: 0.72rem;
    width: 195px;
  }
  #search-box::placeholder { color: #aaa; }
  #search-box:focus { outline: none; border-color: #fdb813; background: white; }
  #search-clear {
    position: absolute;
    right: 8px;
    background: none;
    border: none;
    color: #aaa;
    cursor: pointer;
    font-size: 0.85rem;
    line-height: 1;
    padding: 2px;
    display: none;
  }
  #search-clear:hover { color: #222b54; }

  #main { display: flex; flex: 1; overflow: hidden; }
  #map { flex: 1; }

  #sidebar {
    width: 260px;
    background: white;
    display: flex;
    flex-direction: column;
    border-left: 1px solid #ddd;
    flex-shrink: 0;
  }
  #sidebar-header {
    background: #222b54;
    color: white;
    padding: 8px 13px;
    font-size: 0.75rem;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    gap: 8px;
  }
  #sidebar-header-left { display: flex; align-items: center; gap: 6px; }
  #trainer-count { color: #fdb813; font-size: 0.85rem; }

  #print-btn {
    background: #0ba5a5;
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 3px 9px;
    cursor: pointer;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: background 0.15s;
  }
  #print-btn:hover { background: #089090; }

  #trainer-list { overflow-y: auto; flex: 1; }

  .trainer-card {
    padding: 8px 12px;
    border-bottom: 1px solid #f2efe8;
    cursor: pointer;
    transition: background 0.1s;
  }
  .trainer-card:hover { background: #faf8f4; }
  .trainer-card.selected { background: #e6f4f4; border-left: 3px solid #0ba5a5; padding-left: 9px; }
  .tc-name { font-weight: 700; font-size: 0.81rem; color: #222b54; }
  .tc-location { font-size: 0.7rem; color: #888; margin-top: 1px; }
  .tc-org { font-size: 0.68rem; color: #0ba5a5; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tc-badges { display: flex; gap: 4px; margin-top: 4px; }
  .badge { font-size: 0.61rem; padding: 1px 7px; border-radius: 10px; font-weight: 600; line-height: 1.6; }
  .badge-cohort   { background: #ebe8f5; color: #4a3580; }
  .badge-full     { background: #d8f0dd; color: #1a6632; }
  .badge-prov     { background: #fef3cd; color: #7a5700; }
  .badge-inactive { background: #e8e8ea; color: #555; }

  /* popup */
  .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 16px rgba(0,0,0,0.15); padding: 0; overflow: hidden; }
  .leaflet-popup-content { margin: 0; }
  .popup-inner { padding: 12px 14px; }
  .popup-name { font-weight: 800; font-size: 0.92rem; color: #222b54; margin-bottom: 6px; }
  .popup-row { font-size: 0.77rem; margin-bottom: 3px; color: #444; line-height: 1.4; }
  .popup-row strong { color: #222b54; }
  .popup-row a { color: #0ba5a5; text-decoration: none; }
  .popup-row a:hover { text-decoration: underline; }
  .popup-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 7px; }
  .popup-update { margin-top: 9px; padding-top: 8px; border-top: 1px solid #eee; }
  .popup-update-link {
    font-size: 0.74rem;
    color: #222b54;
    text-decoration: none;
    font-weight: 600;
    opacity: 0.65;
    transition: opacity 0.15s;
  }
  .popup-update-link:hover { opacity: 1; text-decoration: underline; }

  /* ---- Print styles ---- */
  @media print {
    body { overflow: visible; height: auto; }
    #header, #controls, #map, #print-btn { display: none !important; }
    #main { display: block; }
    #sidebar {
      width: 100%;
      border: none;
      display: block;
    }
    #sidebar-header {
      background: #222b54 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      padding: 10px 16px;
      font-size: 0.9rem;
    }
    #trainer-list { overflow: visible; }
    .trainer-card {
      page-break-inside: avoid;
      border-bottom: 1px solid #ddd;
      padding: 7px 16px;
    }
    .trainer-card:hover, .trainer-card.selected { background: white !important; border-left: none !important; padding-left: 16px !important; }
    .tc-name { font-size: 0.88rem; }
    .tc-location, .tc-org { font-size: 0.78rem; }
  }
</style>
</head>
<body>

<div id="header">
  <h1>Support Over Silence for KIDS Certified Trainers Network</h1>
</div>

<div id="controls">
  <div class="filter-group">
    <span class="filter-label">Status:</span>
    <button class="filter-btn active" data-filter="status" data-value="all">All</button>
    <button class="filter-btn" data-filter="status" data-value="not-active">Not Active</button>
    <button class="filter-btn" data-filter="status" data-value="Provisional">Provisional</button>
    <button class="filter-btn" data-filter="status" data-value="Full">Full</button>
  </div>
  <div class="filter-group">
    <span class="filter-label">Cohort:</span>
    <button class="filter-btn active" data-filter="cohort" data-value="all">All</button>
    <button class="filter-btn" data-filter="cohort" data-value="0">0</button>
    <button class="filter-btn" data-filter="cohort" data-value="1">1</button>
    <button class="filter-btn" data-filter="cohort" data-value="2">2</button>
    <button class="filter-btn" data-filter="cohort" data-value="3">3</button>
    <button class="filter-btn" data-filter="cohort" data-value="4">4</button>
    <button class="filter-btn" data-filter="cohort" data-value="5">5</button>
    <button class="filter-btn" data-filter="cohort" data-value="6">6</button>
  </div>
  <div class="filter-group">
    <span class="filter-label">State:</span>
    <select id="state-filter" class="filter-select">
      <option value="all">All</option>
      <option value="KY">KY</option>
      <option value="IL">IL</option>
      <option value="MO">MO</option>
      <option value="IN">IN</option>
      <option value="OH">OH</option>
    </select>
  </div>
  <div id="search-wrap">
    <input type="text" id="search-box" placeholder="Search name, city, org…">
    <button id="search-clear" title="Clear search">✕</button>
  </div>
</div>

<div id="main">
  <div id="map"></div>
  <div id="sidebar">
    <div id="sidebar-header">
      <div id="sidebar-header-left">
        <span>Directory</span>
        <span id="trainer-count">77</span>
      </div>
      <button id="print-btn" onclick="printDirectory()">⬇ Download / Print</button>
    </div>
    <div id="trainer-list"></div>
  </div>
</div>

<script>
// ── Live Google Sheets data source ───────────────────────────────────────────
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwfyYk9YbcWOF131he2x50Q6bXn_Lm_kSCVgkBpBB41lKjIhGJKrqgSUZMfpXnEbl1g_fMmyf71xff/pub?gid=128211378&single=true&output=csv';

const COHORT_DEFAULTS = {
  '0': {city:'Louisville',  state:'KY', lat:38.2527, lng:-85.7585},
  '1': {city:'Louisville',  state:'KY', lat:38.2527, lng:-85.7585},
  '2': {city:'Louisville',  state:'KY', lat:38.2527, lng:-85.7585},
  '3': {city:'Bloomington', state:'IL', lat:40.4842, lng:-88.9937},
  '4': {city:'Lexington',   state:'KY', lat:38.0406, lng:-84.5037},
  '5': {city:'Frankfort',   state:'KY', lat:38.2009, lng:-84.8733},
  '6': {city:'Benton',      state:'KY', lat:36.8578, lng:-88.3503},
};

const CITY_COORDS = {
  'Des Peres_MO':[38.6031,-90.4329], 'St. Louis_MO':[38.6270,-90.1994],
  'Florence_KY':[38.9984,-84.6266],  'Louisville_KY':[38.2527,-85.7585],
  'Lexington_KY':[38.0406,-84.5037], 'Versailles_KY':[38.0517,-84.7299],
  'Bowling Green_KY':[36.9685,-86.4808], 'Frankfort_KY':[38.2009,-84.8733],
  'Shelbyville_KY':[38.2126,-85.2269],   'Richmond_KY':[37.7479,-84.2947],
  'Danville_KY':[37.6459,-84.7721],  'Elizabethtown_KY':[37.6987,-85.8591],
  'Somerset_KY':[37.0920,-84.6041],  'Cadiz_KY':[36.8651,-87.8348],
  'Owensboro_KY':[37.7719,-87.1111], 'Corbin_KY':[36.9495,-84.0966],
  'Benton_KY':[36.8578,-88.3503],    'Crittenden_KY':[38.7823,-84.5999],
  'Carrollton_KY':[38.6817,-85.1758],'Independence_KY':[38.9432,-84.5444],
  'Taylorsville_KY':[38.0320,-85.3441],'Brownsville_KY':[37.1948,-86.2683],
  'Bloomington_IL':[40.4842,-88.9937],'Normal_IL':[40.5142,-88.9906],
};

function formatPhone(p) {
  if (!p) return '';
  const digits = p.replace(/\D/g, '');
  if (digits.length === 10) return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
  if (digits.length === 11 && digits[0] === '1') return `${digits.slice(1,4)}-${digits.slice(4,7)}-${digits.slice(7)}`;
  return p; // return original if can't format
}

function isPhone(s) {
  return /^[\d\s\(\)\-\+\.]{7,}$/.test(s.trim());
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g,'').trim());
  // Store headers for debugging
  parseCSV.lastHeaders = headers;
  return lines.slice(1).filter(l => l.trim()).map(line => {
    const vals = []; let cur = '', inQ = false;
    for (const c of line) {
      if (c === '"') { inQ = !inQ; }
      else if (c === ',' && !inQ) { vals.push(cur.trim()); cur = ''; }
      else cur += c;
    }
    vals.push(cur.trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = (vals[i]||'').replace(/^"|"$/g,'').trim());
    return obj;
  });
}

function cityStateFromAddr(addr) {
  let m = addr.match(/,\s*([A-Za-z][A-Za-z\s\.]+),\s*(?:US-)?([A-Z]{2})[\s,\d]/);
  if (m) return [m[1].trim(), m[2]];
  m = addr.match(/,\s*([A-Za-z][A-Za-z\s\.]+),?\s*(KY|IL|MO|IN|OH|WV|PA|TN)\b/);
  if (m) return [m[1].trim(), m[2]];
  return [null, null];
}

function geoForTrainer(addr, cohort, idx) {
  const jLat = (idx % 7 - 3) * 0.008, jLng = (idx % 5 - 2) * 0.010;
  const [city, state] = cityStateFromAddr(addr || '');
  if (city && state) {
    const c = CITY_COORDS[city+'_'+state];
    if (c) return {city, state, lat: c[0]+jLat, lng: c[1]+jLng};
  }
  const d = COHORT_DEFAULTS[cohort] || COHORT_DEFAULTS['1'];
  return {city:d.city, state:d.state, lat:d.lat+jLat, lng:d.lng+jLng};
}

function rowToTrainer(row, idx) {
  const name = ((row['Name']||'').trim()+' '+(row['Last Name']||'').trim()).trim();
  const cohort = (row['Cohort']||row['Cohort ']||'').trim();
  const geo = geoForTrainer((row['ADDRESS']||'').trim(), cohort, idx);
  // Find org - try all likely column names, skip phone numbers and dates
  const isPhoneOrDate = v => /^[\d\s\(\)\-\+\.x]{7,}$/.test(v) || /^\w+ \d+, \d{4}$/.test(v) || /^\d{4}-\d{2}-\d{2}/.test(v);
  let org = '';
  for (const key of ['Organization', 'Org', 'organization']) {
    const val = (row[key]||'').trim();
    if (val && !isPhoneOrDate(val)) { org = val; break; }
  }
  const emailRaw = (row['Email address']||'').trim();
  const email = emailRaw.includes('@') ? emailRaw : '';
  const phone = formatPhone((row['Phone']||'').trim());
  return { id:idx, name, email, phone, cohort, org, status:(row['Certification status']||'').trim(), ...geo };
}

// ── Fallback data (always loads instantly) ────────────────────────────────────
const FALLBACK = [
  {id:0, name:"Nancy Weaver", email:"nancy@supportoversilence.com", phone:"", cohort:"0", org:"Support Over Silence, LLC", city:"Des Peres", state:"MO", lat:38.5791, lng:-90.4489, status:"Full"},
  {id:1, name:"Jesse Sieger-Walls", email:"jesse@wellbeing-in-action.com", phone:"3143276210", cohort:"1", org:"Wellbeing in Action", city:"St. Louis", state:"MO", lat:38.611, lng:-90.2074, status:"Full"},
  {id:2, name:"Ariel Powell", email:"ariel@echo-ky.org", phone:"", cohort:"1", org:"Exploited Children's Help Organization (ECHO)", city:"Louisville", state:"KY", lat:38.2447, lng:-85.7585, status:"Full"},
  {id:3, name:"Sonja Grey", email:"sonja@echo-ky.org", phone:"502-634-6063", cohort:"1", org:"Exploited Children's Help Organization (ECHO)", city:"Louisville", state:"KY", lat:38.2527, lng:-85.7505, status:"Full"},
  {id:4, name:"Lee Fowlkes", email:"lfowlkes@alliancecounselingky.com", phone:"", cohort:"1", org:"Alliance Counseling", city:"Bowling Green", state:"KY", lat:36.9765, lng:-86.4648, status:"Not active"},
  {id:5, name:"Samantha Berry", email:"samantha@familyenrichmentcenter.com", phone:"2707822030", cohort:"1", org:"Family Enrichment Center, Bowling Green, Kentucky", city:"Louisville", state:"KY", lat:38.2687, lng:-85.7745, status:"Full"},
  {id:6, name:"Andy Bernert", email:"andy.bernert@familynurture.org", phone:"859-538-1629", cohort:"1", org:"Family Nurturing Center", city:"Florence", state:"KY", lat:39.0224, lng:-84.6346, status:"Full"},
  {id:7, name:"Robin Mulcahy", email:"robin.mulcahy@familynurture.org", phone:"859-525-3200", cohort:"1", org:"Family Nurturing Center", city:"Florence", state:"KY", lat:38.9744, lng:-84.6266, status:"Full"},
  {id:8, name:"Megan Patrick", email:"megan@lifeadventurecenter.org", phone:"8598733271", cohort:"1", org:"Life Adventure Center", city:"Versailles", state:"KY", lat:38.0357, lng:-84.7219, status:"Provisional"},
  {id:9, name:"Jessica Eslinger", email:"j.g.eslinger@uky.edu", phone:"8592186961", cohort:"1", org:"University of Kentucky", city:"Lexington", state:"KY", lat:38.0326, lng:-84.4877, status:"Full"},
  {id:10, name:"Tonya Jernigan", email:"tonya.jernigan@uky.edu", phone:"859-619-3823", cohort:"1", org:"University of Kentucky", city:"Lexington", state:"KY", lat:38.0406, lng:-84.5197, status:"Full"},
  {id:11, name:"Heather Webb", email:"hwebb694326@gmail.com; heather.webb@wku.edu", phone:"", cohort:"1", org:"The Integrated Family Trauma Treatment Clinic", city:"Bowling Green", state:"KY", lat:36.9765, lng:-86.4888, status:"Provisional"},
  {id:12, name:"Melissa Muse", email:"melissa@childrensallianceky.org", phone:"", cohort:"2", org:"Children's Alliance", city:"Frankfort", state:"KY", lat:38.2169, lng:-84.8733, status:"Provisional"},
  {id:13, name:"Christian Easton", email:"christian@echo-ky.org", phone:"", cohort:"2", org:"Exploited Children's Help Organization (ECHO)", city:"Louisville", state:"KY", lat:38.2767, lng:-85.7505, status:"Full"},
  {id:14, name:"DeTroya Carr", email:"troya@echo-ky.org", phone:"", cohort:"2", org:"Exploited Children's Help Organization (ECHO)", city:"Louisville", state:"KY", lat:38.2287, lng:-85.7425, status:"Full"},
  {id:15, name:"Katie Dykes", email:"katie@familyenrichmentcenter.com", phone:"270-781-6714", cohort:"2", org:"Family Enrichment Center, Bowling Green, Kentucky", city:"Bowling Green", state:"KY", lat:36.9525, lng:-86.4968, status:"Full"},
  {id:16, name:"Kortney Warren", email:"", phone:"", cohort:"2", org:"Family Enrichment Center, Bowling Green, Kentucky", city:"Louisville", state:"KY", lat:38.2447, lng:-85.7665, status:"Provisional"},
  {id:17, name:"Maggie Myers", email:"Maggie.myers@ky.gov", phone:"8592007777", cohort:"2", org:"Family Resource and Youth Service Centers", city:"Danville", state:"KY", lat:37.6459, lng:-84.7721, status:"Full"},
  {id:18, name:"Melanie Madison", email:"melanie.madison@ky.gov", phone:"5023307613", cohort:"2", org:"Family Resource and Youth Service Centers", city:"Louisville", state:"KY", lat:38.2607, lng:-85.7505, status:"Full"},
  {id:19, name:"Melissa Wallace", email:"mwallace@lexingtonky.gov", phone:"859-230-0114", cohort:"2", org:"LFUCG-Social services, Domestic Violence & Sexual Violence Prevention Coalition", city:"Lexington", state:"KY", lat:38.0566, lng:-84.4877, status:"Provisional"},
  {id:20, name:"Bailee Hubert", email:"bailee.herbert@uky.edu", phone:"5025981621", cohort:"2", org:"University of Kentucky, Pediatric Forensic Medicine", city:"Louisville", state:"KY", lat:38.2767, lng:-85.7745, status:"Provisional"},
  {id:21, name:"Carla Hay", email:"carla.hay@uky.edu", phone:"6064830010", cohort:"2", org:"University of Kentucky, Pediatric Forensic Medicine", city:"Louisville", state:"KY", lat:38.2287, lng:-85.7665, status:"Provisional"},
  {id:22, name:"Angela Masden", email:"cedirector@playcousinscollective.com", phone:"", cohort:"2", org:"Play Cousins Collective", city:"Louisville", state:"KY", lat:38.2367, lng:-85.7585, status:"Provisional"},
  {id:23, name:"Misha Bondarenko", email:"Mbondarenko@greenhouse17.org", phone:"", cohort:"2", org:"GreenHouse17", city:"Louisville", state:"KY", lat:38.2447, lng:-85.7505, status:"Not active"},
  {id:24, name:"Trys Cool", email:"", phone:"", cohort:"2", org:"GreenHouse17", city:"Louisville", state:"KY", lat:38.2527, lng:-85.7425, status:"Not active"},
  {id:25, name:"Kalyn Patterson", email:"KPatterson@cyfsolutions.org", phone:"309-216-0404", cohort:"3", org:"The Center for Youth and Family Solutions", city:"Bloomington", state:"IL", lat:40.4922, lng:-89.0097, status:"Full"},
  {id:26, name:"Maureen Sollars", email:"Maureen.Sollars@mcleancountyil.gov", phone:"309-888-5539", cohort:"3", org:"McLean County AOK", city:"Bloomington", state:"IL", lat:40.5002, lng:-89.0017, status:"Full"},
  {id:27, name:"Undra Uphoff", email:"creativeheal23@gmail.com", phone:"", cohort:"3", org:"Creative Healing Expressive Arts Center", city:"Bloomington", state:"IL", lat:40.5082, lng:-88.9937, status:"Provisional"},
  {id:28, name:"Catrina Parker", email:"catrinatparker@gmail.com", phone:"708268751", cohort:"3", org:"", city:"Bloomington", state:"IL", lat:40.4602, lng:-88.9857, status:"Provisional"},
  {id:29, name:"Javi Monardez", email:"javieramonardez@gmail.com", phone:"9178258095", cohort:"3", org:"Familia Solutions", city:"Normal", state:"IL", lat:40.4982, lng:-88.9746, status:"Full"},
  {id:30, name:"Verneice Prince", email:"verneice@integrityhelps.org", phone:"5863433539", cohort:"3", org:"Integrity Counseling", city:"Bloomington", state:"IL", lat:40.4762, lng:-89.0097, status:"Provisional"},
  {id:31, name:"Karisma Morris-Bush", email:"kmorrisbush@gmail.com", phone:"309-706-3527", cohort:"3", org:"System of Care", city:"Bloomington", state:"IL", lat:40.4842, lng:-89.0017, status:"Full"},
  {id:32, name:"Belina Shelton", email:"belina.shelton@ky.gov", phone:"", cohort:"4", org:"Division of Prevention and Community Well Being", city:"Lexington", state:"KY", lat:38.0486, lng:-84.5037, status:"Full"},
  {id:33, name:"Derek Baker", email:"derek.baker@ky.gov", phone:"", cohort:"4", org:"Division of Prevention and Community Well Being", city:"Lexington", state:"KY", lat:38.0566, lng:-84.4957, status:"Provisional"},
  {id:34, name:"Margaret Perkins", email:"margaret.perkins@ky.gov", phone:"859-582-3775", cohort:"4", org:"Division of Prevention and Community Well Being", city:"Richmond", state:"KY", lat:37.7719, lng:-84.2787, status:"Full"},
  {id:35, name:"Lynne Mason", email:"lynne.mason@ky.gov", phone:"502-744-8117", cohort:"4", org:"Division of Prevention and Community Well Being", city:"Louisville", state:"KY", lat:38.2287, lng:-85.7745, status:"Full"},
  {id:36, name:"Dana Fryman", email:"danaa.fryman@ky.gov", phone:"", cohort:"4", org:"Division of Prevention and Community Well Being", city:"Lexington", state:"KY", lat:38.0246, lng:-84.5117, status:"Provisional"},
  {id:37, name:"Kristy James", email:"kristy.james@ky.gov", phone:"", cohort:"4", org:"Division of Prevention and Community Well Being", city:"Lexington", state:"KY", lat:38.0326, lng:-84.5037, status:"Full"},
  {id:38, name:"Tia Humphrey", email:"Tia.humphrey@ky.gov", phone:"", cohort:"4", org:"DCBS", city:"Louisville", state:"KY", lat:38.2527, lng:-85.7505, status:"Provisional"},
  {id:39, name:"Suzanne Lee", email:"Slee@foothillscap.org", phone:"8595826925", cohort:"4", org:"CCC - Kentucky River Foothills", city:"Richmond", state:"KY", lat:37.7559, lng:-84.2787, status:"Provisional"},
  {id:40, name:"Amanda Oliver", email:"A.Oliver.Altparentrepriac@gmail.com", phone:"406-489-6907", cohort:"4", org:"CCC", city:"Cadiz", state:"KY", lat:36.8811, lng:-87.8508, status:"Provisional"},
  {id:41, name:"Andrea Willis", email:"awillis@casoky.org", phone:"", cohort:"4", org:"Community Action of Southern", city:"Lexington", state:"KY", lat:38.0646, lng:-84.5117, status:"Full"},
  {id:42, name:"Sabrina Davis", email:"Sabrina.B@pacs-ky.org", phone:"", cohort:"4", org:"PACS/CCC", city:"Lexington", state:"KY", lat:38.0166, lng:-84.5037, status:"Full"},
  {id:43, name:"Mickey Little", email:"mlittle@pcaky.org", phone:"", cohort:"4", org:"PCAK", city:"Lexington", state:"KY", lat:38.0246, lng:-84.4957, status:"Not active"},
  {id:44, name:"Amanda Clark", email:"aclark@pcaky.org", phone:"2708776389", cohort:"4", org:"PCAK", city:"Elizabethtown", state:"KY", lat:37.6907, lng:-85.8431, status:"Provisional"},
  {id:45, name:"Chris Prichard", email:"cprichard@pcaky.org", phone:"6062071055", cohort:"4", org:"PCAK", city:"Lexington", state:"KY", lat:38.0406, lng:-84.5197, status:"Provisional"},
  {id:46, name:"Aaron Ames", email:"aames@ccffky.org", phone:"", cohort:"4", org:"Commonwealth Center for Fathers and Families", city:"Lexington", state:"KY", lat:38.0486, lng:-84.5117, status:"Provisional"},
  {id:47, name:"Tyler Barrett", email:"Tbarrett@ccffky.org", phone:"8592090122", cohort:"4", org:"Commonwealth Center for Fathers and Families", city:"Somerset", state:"KY", lat:37.108, lng:-84.6041, status:"Provisional"},
  {id:48, name:"Danielle Harrison", email:"d.harrison@gatewaychildren.org", phone:"", cohort:"4", org:"Gateway Children's Services", city:"Lexington", state:"KY", lat:38.0646, lng:-84.4957, status:"Provisional"},
  {id:49, name:"Abigail Emmons", email:"A.emmons@gatewaychildren.org", phone:"", cohort:"4", org:"Gateway Children's Services", city:"Lexington", state:"KY", lat:38.0166, lng:-84.4877, status:"Provisional"},
  {id:50, name:"Sabrina Durbin", email:"sabrina.durbin92@gmail.com", phone:"2705644323", cohort:"4", org:"Contractor", city:"Brownsville", state:"KY", lat:37.1788, lng:-86.2843, status:"Provisional"},
  {id:51, name:"Tiffany Mullis", email:"tiffany.mullis@ky.gov", phone:"8593911332", cohort:"5", org:"", city:"Independence", state:"KY", lat:38.9352, lng:-84.5524, status:"Provisional"},
  {id:52, name:"Robert Thompson", email:"robertj.thompson@ky.gov", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2009, lng:-84.8733, status:"Provisional"},
  {id:53, name:"Jenny Thornhill", email:"Jennifer.Thornhill@ky.gov", phone:"502-550-3761", cohort:"5", org:"", city:"Taylorsville", state:"KY", lat:38.04, lng:-85.3361, status:"Provisional"},
  {id:54, name:"Christina Lucas", email:"christina.lucas@ky.gov", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2169, lng:-84.8573, status:"Provisional"},
  {id:55, name:"Jaime Tipton", email:"jaime.tipton@ky.gov", phone:"502-487-0989", cohort:"5", org:"", city:"Shelbyville", state:"KY", lat:38.2366, lng:-85.2429, status:"Provisional"},
  {id:56, name:"Jenny Mead", email:"jenny.mead@ky.gov", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.1769, lng:-84.8813, status:"Provisional"},
  {id:57, name:"Kaye Thompson", email:"kaye.thompson@ky.gov", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.1849, lng:-84.8733, status:"Provisional"},
  {id:58, name:"Melanie Lyon", email:"mlyon@pcaky.org", phone:"8592258879", cohort:"5", org:"", city:"Lexington", state:"KY", lat:38.0326, lng:-84.4957, status:"Provisional"},
  {id:59, name:"Donyell Walker", email:"donyellwalker1989@gmail.com", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2009, lng:-84.8573, status:"Provisional"},
  {id:60, name:"Jazmine Head", email:"jazminehead74@gmail.com", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2089, lng:-84.8893, status:"Provisional"},
  {id:61, name:"Miranda Boggs", email:"miranda.boggs@nkcaa.net", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2169, lng:-84.8813, status:"Provisional"},
  {id:62, name:"Laura Browning", email:"laura.c.browning@gmail.com", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2249, lng:-84.8733, status:"Provisional"},
  {id:63, name:"Ronda Bertrand", email:"ronda.bertrand@ckcac.org", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.1769, lng:-84.8653, status:"Provisional"},
  {id:64, name:"Robin Miller", email:"rmiller32@msn.com", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.1849, lng:-84.8573, status:"Provisional"},
  {id:65, name:"Valerie Lebanion", email:"valerie.lebanion@crccc.org", phone:"606-521-0177", cohort:"5", org:"", city:"Corbin", state:"KY", lat:36.9415, lng:-84.1126, status:"Full"},
  {id:66, name:"Katie Habas", email:"khabas@nkcac.org", phone:"502-640-8290", cohort:"5", org:"", city:"Carrollton", state:"KY", lat:38.6817, lng:-85.1838, status:"Provisional"},
  {id:67, name:"Sarah Quackenbush", email:"squackenbush@nkcac.org", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2089, lng:-84.8733, status:"Provisional"},
  {id:68, name:"Careatha Smith", email:"careathaw@gmail.com", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2169, lng:-84.8653, status:"Full"},
  {id:69, name:"Tonia Godfrey", email:"tgodfrey@brightoncenter.com", phone:"", cohort:"5", org:"", city:"Frankfort", state:"KY", lat:38.2249, lng:-84.8573, status:"Not active"},
  {id:70, name:"Kristy James", email:"kristy.james@ky.gov", phone:"2709296294", cohort:"5", org:"", city:"Owensboro", state:"KY", lat:37.7479, lng:-87.1271, status:"Full"},
  {id:71, name:"Tammy Blackwell", email:"tblackwell@marshallcolibrary.org", phone:"270-205-6719", cohort:"6", org:"Marshall County Public Library", city:"Benton", state:"KY", lat:36.8418, lng:-88.3583, status:"Full"},
  {id:72, name:"Lena Mallory", email:"lmallory@uky.edu", phone:"270-527-3285 (Work)", cohort:"6", org:"", city:"Benton", state:"KY", lat:36.8498, lng:-88.3503, status:"Full"},
  {id:73, name:"Jennifer McComas", email:"jennife.mccomas@ky.gov", phone:"859-743-2517", cohort:"6", org:"CHFS/DCBS", city:"Crittenden", state:"KY", lat:38.7823, lng:-84.5919, status:"Provisional"},
  {id:74, name:"Erika Clapp", email:"erika.clapp@pacs-ky.org", phone:"1270-627-3190", cohort:"6", org:"Pennyrile Allied Community Services", city:"Benton", state:"KY", lat:36.8658, lng:-88.3343, status:"Full"},
  {id:75, name:"Cortney Downs", email:"cdowns@kyyouth.org", phone:"", cohort:"6", org:"Kentucky Youth Advocates", city:"Benton", state:"KY", lat:36.8738, lng:-88.3663, status:"Provisional"},
  {id:76, name:"Dana Wrinkle", email:"dwrinkle@childwatchcac.org", phone:"", cohort:"6", org:"Child Watch Counseling and Advocacy Center", city:"Benton", state:"KY", lat:36.8818, lng:-88.3583, status:"Provisional"},
];

let trainers = FALLBACK.map(t => ({...t, phone: formatPhone(t.phone)}));

// Then silently try to fetch fresh data in the background
const SHEET_ID = '1cf21cfRbpjj1JR3ddJhtpxGCC5CpnhssoZ3376k258Q';
const GID = '128211378';

function loadCSV() {
  return new Promise((resolve, reject) => {
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}&headers=1`;
    fetch(gvizUrl)
      .then(r => { if (!r.ok) throw new Error('gviz failed'); return r.text(); })
      .then(resolve)
      .catch(() => {
        fetch(`https://opensheet.elk.sh/${SHEET_ID}/${GID}`)
          .then(r => r.json())
          .then(json => {
            if (!json || !json.length) throw new Error('empty');
            const headers = Object.keys(json[0]).join(',');
            const rows = json.map(r => Object.values(r).map(v => `"${(v||'').replace(/"/g,'""')}"`).join(','));
            resolve(headers + '\n' + rows.join('\n'));
          })
          .catch(reject);
      });
  });
}

// Background refresh — silently updates if successful
loadCSV()
  .then(text => {
    const rows = parseCSV(text);
    const fresh = rows.filter(r => (r['Name']||'').trim()).map((row, i) => rowToTrainer(row, i));
    if (fresh.length > 0) {
      trainers = fresh;
      render();
    }
  })
  .catch(() => { /* silently fail — fallback data already showing */ });


let filters = {status:'all', cohort:'all', state:'all', search:''};
let selectedId = null;
let markers = {};

// Carto Voyager — has state/county lines but no red road numbers
const map = L.map('map', {center:[38.4,-85.6], zoom:7});
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains:'abcd', maxZoom:19
}).addTo(map);

// US state boundaries overlay from a public GeoJSON
fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
  .then(r => r.json())
  .then(data => {
    L.geoJSON(data, {
      style: { color: '#7a8bbf', weight: 1.4, fillOpacity: 0, dashArray: null }
    }).addTo(map);
  }).catch(() => {});

function pinIcon() {
  return L.divIcon({
    html:`<svg xmlns="http://www.w3.org/2000/svg" width="20" height="30" viewBox="0 0 20 30">
      <path d="M10 0C4.48 0 0 4.48 0 10c0 7 10 20 10 20S20 17 20 10C20 4.48 15.52 0 10 0z" fill="#222b54" stroke="white" stroke-width="1.2"/>
      <circle cx="10" cy="10" r="4" fill="#fdb813"/>
    </svg>`,
    className:'', iconSize:[20,30], iconAnchor:[10,30], popupAnchor:[0,-30]
  });
}

function statusBadge(status) {
  if (status === 'Full')        return '<span class="badge badge-full">Full</span>';
  if (status === 'Provisional') return '<span class="badge badge-prov">Provisional</span>';
  return '<span class="badge badge-inactive">Not Active</span>';
}

function isNotActive(t) { return t.status === 'Not active'; }

function getFiltered() {
  return trainers.filter(t => {
    if (filters.cohort !== 'all' && t.cohort !== filters.cohort) return false;
    if (filters.status === 'not-active'  && !isNotActive(t))      return false;
    if (filters.status === 'Full'        && t.status !== 'Full')  return false;
    if (filters.status === 'Provisional' && t.status !== 'Provisional') return false;
    if (filters.state !== 'all' && t.state !== filters.state) return false;
    if (filters.search) {
      const q = filters.search.toLowerCase();
      if (![t.name, t.city, t.org, t.state].some(f => (f||'').toLowerCase().includes(q))) return false;
    }
    return true;
  });
}

function render() {
  const filtered = getFiltered();
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};

  filtered.forEach(t => {
    const m = L.marker([t.lat, t.lng], {icon: pinIcon()});
    const emailHtml = t.email ? `<a href="mailto:${t.email}">${t.email}</a>` : '—';
    const subject = encodeURIComponent(`Trainer Info Update – ${t.name}`);
    const body = encodeURIComponent(`Hi Nancy,\n\nI'd like to update my Support Over Silence trainer information in the network directory.\n\nName: ${t.name}\nCurrent location: ${t.city}, ${t.state}\nCurrent org: ${t.org || '—'}\nCurrent phone: ${t.phone || '—'}\nCurrent status: ${t.status}\n\nWhat needs to change:\n[Please describe your updates here]\n\nThank you!`);
    const updateLink = `<a href="mailto:info@supportoversilence.com?subject=${subject}&body=${body}" class="popup-update-link">✏ Update my info</a>`;

    m.bindPopup(`<div class="popup-inner">
      <div class="popup-name">${t.name}</div>
      <div class="popup-row"><strong>Location:</strong> ${t.city}, ${t.state}</div>
      ${t.org ? `<div class="popup-row"><strong>Org:</strong> ${t.org}</div>` : ''}
      <div class="popup-row"><strong>Email:</strong> ${emailHtml}</div>
      ${t.phone ? `<div class="popup-row"><strong>Phone:</strong> ${t.phone}</div>` : ''}
      <div class="popup-badges">
        <span class="badge badge-cohort">Cohort ${t.cohort}</span>
        ${statusBadge(t.status)}
      </div>
      <div class="popup-update">${updateLink}</div>
    </div>`, {maxWidth:270});
    m.on('click', () => selectTrainer(t.id, false));
    m.addTo(map);
    markers[t.id] = m;
  });

  const list = document.getElementById('trainer-list');
  list.innerHTML = '';
  [...filtered].sort((a,b) => a.name.localeCompare(b.name)).forEach(t => {
    const div = document.createElement('div');
    div.className = 'trainer-card' + (t.id === selectedId ? ' selected' : '');
    div.id = `card-${t.id}`;
    div.innerHTML = `
      <div class="tc-name">${t.name}</div>
      <div class="tc-location">${t.city}, ${t.state}</div>
      ${t.org ? `<div class="tc-org">${t.org}</div>` : ''}
      ${t.phone ? `<div class="tc-org" style="color:#888;">${t.phone}</div>` : ''}
      <div class="tc-badges">
        <span class="badge badge-cohort">Cohort ${t.cohort}</span>
        ${statusBadge(t.status)}
      </div>`;
    div.addEventListener('click', () => selectTrainer(t.id, true));
    list.appendChild(div);
  });

  document.getElementById('trainer-count').textContent = filtered.length;
}

function selectTrainer(id, pan) {
  selectedId = id;
  document.querySelectorAll('.trainer-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById(`card-${id}`);
  if (card) { card.classList.add('selected'); card.scrollIntoView({block:'nearest'}); }
  if (markers[id]) {
    if (pan) { const t = trainers.find(x => x.id===id); map.setView([t.lat, t.lng], 11); }
    markers[id].openPopup();
  }
}

// Search box with clear button
const searchBox = document.getElementById('search-box');
const clearBtn  = document.getElementById('search-clear');
searchBox.addEventListener('input', e => {
  filters.search = e.target.value.trim();
  clearBtn.style.display = filters.search ? 'block' : 'none';
  render();
});
clearBtn.addEventListener('click', () => {
  searchBox.value = '';
  filters.search = '';
  clearBtn.style.display = 'none';
  searchBox.focus();
  render();
});

// State filter dropdown
document.getElementById('state-filter').addEventListener('change', e => {
  filters.state = e.target.value;
  render();
});

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const g = btn.dataset.filter;
    document.querySelectorAll(`[data-filter="${g}"]`).forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filters[g] = btn.dataset.value;
    render();
  });
});

// Print / download directory
function printDirectory() {
  // Inject a temporary print-only header showing active filters
  const filtered = getFiltered();
  const statusLabel = filters.status === 'all' ? 'All Statuses' :
                      filters.status === 'not-active' ? 'Not Active' : filters.status;
  const cohortLabel = filters.cohort === 'all' ? 'All Cohorts' : 'Cohort ' + filters.cohort;
  const searchLabel = filters.search ? ` · Search: "${filters.search}"` : '';
  const subtitle = `${statusLabel} · ${cohortLabel}${searchLabel} · ${filtered.length} trainers`;

  let ph = document.getElementById('print-header');
  if (!ph) {
    ph = document.createElement('div');
    ph.id = 'print-header';
    ph.style.cssText = 'display:none';
    document.body.insertBefore(ph, document.body.firstChild);
  }
  ph.innerHTML = `<div style="background:#222b54;color:white;padding:12px 18px;-webkit-print-color-adjust:exact;print-color-adjust:exact;">
    <div style="font-size:1rem;font-weight:800;">Support Over Silence for KIDS Certified Trainers Network</div>
    <div style="font-size:0.78rem;opacity:0.8;margin-top:3px;">${subtitle}</div>
  </div>`;

  // Show it only during print
  const style = document.createElement('style');
  style.id = 'print-inject';
  style.textContent = '@media print { #print-header { display: block !important; } }';
  document.head.appendChild(style);

  window.print();

  // Clean up injected style after print dialog closes
  setTimeout(() => { const s = document.getElementById('print-inject'); if (s) s.remove(); }, 1000);
}
// Initial render with fallback data
render();

</script>
</body>
</html>
